import os
import json
import getReq
import getSetup
import checkRequirements


topdir= '/srv/pypi/web/packages/source'
req_string = ''
problematicPackages = []
reqs = {}
reqSet = {}
prereqs = {}
counter = 0


for dirpath,dirnames, files in os.walk(topdir):
  for name in files:
    # Stop from looking within package for other setup.py
    if(os.path.join(dirpath,name).count("/") < 10):
	    if name == 'setup.py':
	      counter = counter + 1
	      packageName = dirpath[dirpath.rfind('/')+1:len(dirpath)]
	      # Should return none if there is no requires.txt.
	      req_string = getReq.get_from_require(os.path.join(dirpath,''))
	      if req_string:
		req_list_set = req_string.split()
	     
	      else: 
		req_list_set = []

	      
	      try:
	    	  dataFile = file(os.path.join(dirpath,name))
	      except Exception:
		  problematicPackages.append(packageName)
		  continue
	      req_string = getSetup.get_from_setup(dataFile,packageName)
	      if req_string:
		  if '(' in req_string:		
		  # Make sure it's not numpy(<=1.2) before going to check requirements.txt
		    if not (req_string[req_string.find('(')+1]=='<' or \
		    req_string[req_string.find('(')+1]=='>' or \
		    req_string[req_string.find('(')+1]=='='):
		      req_string = checkRequirements.get_requirements(os.path.join(dirpath,''))

		    if req_string: 
		      
		      req_list = req_string.split()
		
		    else:
		      req_list = []

		  else:
		    req_list = req_string.split() 

	      else:
		  req_list = [] 
	   
	      # Package name is key and list of dependency is value
	      dict_value = []
	      for u in req_list:
		dict_value.append(u)
	      reqs[packageName] = dict_value

	      dict_value_set = []
	      for u in req_list_set:
		dict_value_set.append(u)
	      reqSet[packageName] = dict_value_set
	      print counter
	     
     
     
print counter
with open("probGetPak.txt",'w') as probPak:
  for packName in problematicPackages:
    probPak.write(packName + '\n')	

			
json.dump(reqs, open("reqsetup.txt",'w'))
json.dump(reqSet, open("reqtxt.txt",'w'))
								
										


